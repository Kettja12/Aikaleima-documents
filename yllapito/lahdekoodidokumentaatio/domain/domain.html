<html>
<head>
    <meta charset="UTF-8">
    <title>Domain-komponentit</title>

    <link rel="stylesheet" href="/css/app.css">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/prism.css">

    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/prism.js" data-manual></script>
    <script src="/js/prism-file-highlight.js"></script>

    <!-- Lisätään Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

</head>
<body>
    <article>
    <h2>Domain-komponentit</h2>
    <p style="overflow: auto;">
      <img src="domain.png" alt="domain" width="200" style="float: left; margin-right: 15px; margin-bottom: 5px;" />

        <a href="https://github.com/Kettja12/aikajana-ssr/blob/e072c1b609c987aa242d944edb39cef923bf0fcd/Domain/?plain=1"
         class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener noreferrer">Domain-kansio</a>
        sisältää jokaista näkymää vastaavan `Model`-luokan (esim. `UserModel`). Kukin `Model`-luokka sisältää näytön tarvitseman toimintalogiikan ja metodit, 
        jotka hakevat tiedot `Repository`-moduulista `State`-luokan kautta `Services`-metodeilla.
        `Model`-luokka on tietoinen `State`-luokasta ja pääsee sen kautta tarpeen mukaan käsiksi muihin tilan `Model`-luokkiin. Näin toteutetaan esimerkiksi tilanne, jossa `DeviceModel` tarvitsee leimauslajeja: se voi kutsua 
        `state.StampcategoryModel`-luokan metodeja, kuten `state.StampcategoryModel.SelectStampcategory(2345)`.
    </p>
    <h3>Luokkakaavio</h3>
    <div class="mermaid">
      graph TD
        subgraph "Domain: State (partial class)"
            StateBase["<b>State.cs</b><br/>+ Loaded: bool<br/>+ LoginToken: string<br/>+ MessageType: string<br/>+ MessageContent: string"]
            Users["<b>State.Users.cs</b><br/>+ UserModel: UserModel<br/>+ LoadUsersAsync()<br/>+ SaveUserAsync()<br/>+ SelectUser(id)"]
            Devices["<b>State.Devices.cs</b><br/>+ DeviceModel: DeviceModel<br/>+ LoadDevicesAsync()<br/>+ SaveDeviceAsync()<br/>+ SelectDevice(id)"]
            Stamps["<b>State.Stamps.cs</b><br/>+ StampModel: StampModel<br/>+ LoadStampsAsync()<br/>+ MarkTransferedAsync()<br/>+ DeleteTransferedAsync()"]
            Stampers["<b>State.Stampers.cs</b><br/>+ StamperModel: StamperModel<br/>+ LoadStampersAsync()<br/>+ SaveStamperAsync()<br/>+ SelectStamper(id)"]
            StampCategories["<b>State.StampCategories.cs</b><br/>+ StampcategoryModel: StampcategoryModel<br/>+ LoadStampCategoriesAsync()<br/>+ SaveStampCategoryAsync()<br/>+ SelectStampCategory(id)"]
        end
        ServicesBox["<b>Services</b><br/><a href="../repository/repository.html#Services">(Repository)</a>"]
        StateBase <-->|Kutsuu metodeja / Palauttaa dataa| ServicesBox
    </div>
    <h3>Tila</h3>
    <p>
        <a href="https://github.com/Kettja12/aikajana-ssr/blob/e072c1b609c987aa242d944edb39cef923bf0fcd/Domain/State.cs?plain=1"
         class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener noreferrer">State-luokka</a>
        hoitaa sovelluksen tilanhallinnan. Jokaisella käyttäjällä on selaimen istunnon ajan oma instanssinsa tilasta, 
        vastaavasti kuin Web Forms -sovelluksissa `Session`-olio. Tila on osa domain-kerrosta ja huolehtii domain-objekteista.
        Kuten koodista näkee, `State`-luokan instanssi saa parametrinaan `Services`-luokan, jota tila käyttää tietojen tuontiin ja vientiin tietokannasta.
        `State`-luokan ydintiedosto sisältää myös metodit, joilla serialisoidaan ja deserialisoidaan avainluokka, joka tallennetaan selaimen IndexedDB-tietokantaan. 
        Olisi mielenkiintoista kuulla, miten kolmas osapuoli voisi saada tämän tiedon haltuunsa ilman pääsyä asiakaskoneelle ja asentaa sen omalle koneelleen. 
        Vaikka näin pääsisi tapahtumaan, sovelluksessa on kaksi toimintoa, jotka estävät luvattoman käytön: PIN-koodi ja tunnistautuminen puhelinsovelluksella,
        mikäli ne on otettu käyttöön. 

        <pre data-src="State.cs" class="language-csharp"></pre>
    </p>
    <h3>Esimerkki UserModel-tiedosto</h3>
    <p>
        Koodiesimerkistä näkee, että `UserModel.cs` on `partial`-luokka `State`-luokasta. Tämän ansiosta kaikki tiedoston metodit ovat `State`-luokan metodeja. 
        Näin `State` muodostaa domain-tason, joka sisältää entiteettejä, kuten `UserModel`, joita käyttöliittymä hyödyntää. 
        Kaikki metodit ovat `State`-luokan metodeja, joilla haetaan ja tallennetaan tietoja `Services`-luokan instanssin kautta. 
        Metodit on ryhmitelty loogisiin kokonaisuuksiin omiin `partial`-tiedostoihinsa.   
        <pre data-src="UserModel.cs" class="language-csharp"></pre>
    </p>
    </article>
    <script>
        // Alustetaan Mermaid
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>